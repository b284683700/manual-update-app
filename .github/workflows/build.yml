name: Build Manual Update App APK

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ“¦ Install dependencies
        run: npm install
      
      - name: ðŸ—ï¸ Export Android project
        run: npx expo prebuild --platform android --clean
      
      - name: ðŸ”‘ Generate signing key
        run: |
          keytool -genkeypair -v -storetype PKCS12 \
            -keystore android/app/release.keystore \
            -alias release \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Manual Update App, OU=Mobile, O=MyCompany, L=City, S=State, C=CN"
      
      - name: âš™ï¸ Configure signing
        run: |
          # ç¡®ä¿ gradle.properties æ–‡ä»¶å­˜åœ¨å¹¶ä»¥æ¢è¡Œç¬¦ç»“å°¾
          if [ ! -f android/gradle.properties ]; then
            touch android/gradle.properties
          fi
          
          # ç¡®ä¿æ–‡ä»¶ä»¥æ¢è¡Œç¬¦ç»“å°¾
          [ -n "$(tail -c1 android/gradle.properties)" ] && echo "" >> android/gradle.properties
          
          # æ·»åŠ ç­¾åé…ç½®
          cat >> android/gradle.properties << 'EOF'
          
          # Release signing config
          MYAPP_RELEASE_STORE_FILE=release.keystore
          MYAPP_RELEASE_KEY_ALIAS=release
          MYAPP_RELEASE_STORE_PASSWORD=android
          MYAPP_RELEASE_KEY_PASSWORD=android
          EOF
          
          # æ˜¾ç¤ºé…ç½®å†…å®¹
          echo "=== gradle.properties å†…å®¹ ==="
          cat android/gradle.properties
      
      - name: ðŸ“ Modify build.gradle for signing
        run: |
          # å¤‡ä»½åŽŸæ–‡ä»¶
          cp android/app/build.gradle android/app/build.gradle.bak
          
          # ä½¿ç”¨ Python è„šæœ¬æ¥ä¿®æ”¹ build.gradle
          python3 << 'PYTHON_SCRIPT'
          import re
          
          with open('android/app/build.gradle', 'r') as f:
              content = f.read()
          
          # 1. åœ¨ android { åŽæ·»åŠ  signingConfigs
          signing_config = '''
              signingConfigs {
                  debug {
                      storeFile file('debug.keystore')
                      storePassword 'android'
                      keyAlias 'androiddebugkey'
                      keyPassword 'android'
                  }
                  release {
                      if (project.hasProperty('MYAPP_RELEASE_STORE_FILE')) {
                          storeFile file(MYAPP_RELEASE_STORE_FILE)
                          storePassword MYAPP_RELEASE_STORE_PASSWORD
                          keyAlias MYAPP_RELEASE_KEY_ALIAS
                          keyPassword MYAPP_RELEASE_KEY_PASSWORD
                      }
                  }
              }
          '''
          
          # æŸ¥æ‰¾ android { å¹¶åœ¨å…¶åŽæ’å…¥ signingConfigs
          if 'signingConfigs' not in content:
              content = re.sub(
                  r'(android\s*\{)',
                  r'\1' + signing_config,
                  content,
                  count=1
              )
          
          # 2. ä¿®æ”¹ buildTypes ä¸­çš„ release é…ç½®
          # æŸ¥æ‰¾ buildTypes å—
          buildtypes_pattern = r'(buildTypes\s*\{[^}]*)(release\s*\{[^}]*\})'
          
          def replace_release(match):
              before = match.group(1)
              release_block = '''release {
                  signingConfig signingConfigs.release
                  minifyEnabled enableProguardInReleaseBuilds
                  proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
              }'''
              return before + release_block
          
          content = re.sub(buildtypes_pattern, replace_release, content, flags=re.DOTALL)
          
          # 3. ç¡®ä¿ debug é…ç½®ä¹Ÿå­˜åœ¨
          if 'buildTypes' in content and 'debug {' not in content:
              content = re.sub(
                  r'(buildTypes\s*\{)',
                  r'\1\n        debug {\n            signingConfig signingConfigs.debug\n        }',
                  content,
                  count=1
              )
          
          with open('android/app/build.gradle', 'w') as f:
              f.write(content)
          
          print("âœ… build.gradle ä¿®æ”¹å®Œæˆ")
          PYTHON_SCRIPT
          
          # æ˜¾ç¤ºä¿®æ”¹åŽçš„å…³é”®éƒ¨åˆ†
          echo "=== ä¿®æ”¹åŽçš„ signingConfigs å’Œ buildTypes ==="
          sed -n '/signingConfigs/,/^    }/p' android/app/build.gradle
          sed -n '/buildTypes/,/^    }/p' android/app/build.gradle
      
      - name: ðŸ”¨ Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease
      
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: manual-update-app-release
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30
      
      - name: ðŸŽ‰ Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          files: android/app/build/outputs/apk/release/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
